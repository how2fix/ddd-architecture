classDiagram
    %% ==========================================
    %% DDDæ¶æ„ç±»å›¾ v2.0 - åŸºäºå®é™…ä»£ç å®ç°
    %% ==========================================

    %% ==========================================
    %% user-start æ¨¡å—
    %% ==========================================
    class UserApplication {
        <<@SpringBootApplication>>
        ğŸ“ user-start/UserApplication.java
        +main(args) void
    }

    %% ==========================================
    %% user-adapter æ¨¡å—
    %% ==========================================
    class UserController {
        <<RestController>>
        ğŸ“ user-adapter/web/UserController.java
        +register(cmd) Response
        +getById(id) Response
        +health() Response
    }

    class GlobalExceptionHandler {
        <<RestControllerAdvice>>
        ğŸ“ user-adapter/exception/GlobalExceptionHandler.java
        +handleBizException(e) Response
        +handleValidationException(e) Response
    }

    %% ==========================================
    %% user-client æ¨¡å—
    %% ==========================================
    class UserServiceI {
        <<interface>>
        ğŸ“ user-client/api/UserServiceI.java
        +register(cmd) Response
        +getById(qry) Response
    }

    class UserRegisterCmd {
        <<Command>>
        ğŸ“ user-client/dto/cmd/UserRegisterCmd.java
        +String username
        +String email
        +String password
        +String phone
        +Boolean sendEmail
        +Boolean sendSms
    }

    class UserByIdQry {
        <<Query>>
        ğŸ“ user-client/dto/query/UserByIdQry.java
        +Long userId
    }

    class UserDTO {
        ğŸ“ user-client/dto/UserDTO.java
        +Long id
        +String username
        +String email
        +String phone
        +String status
        +LocalDateTime registerTime
    }

    class Response~T~ {
        ğŸ“ user-client/dto/Response.java
        +boolean success
        +String errCode
        +String errMessage
        +T data
        +buildSuccess(data) Response
        +buildFailure(errCode, errMsg) Response
    }

    class ErrorCode {
        <<enumeration>>
        ğŸ“ user-client/exception/ErrorCode.java
        PARAM_INVALID
        EMAIL_FORMAT_ERROR
        USER_NOT_FOUND
        EMAIL_ALREADY_EXISTS
        SYSTEM_ERROR
    }

    class BizException {
        ğŸ“ user-client/exception/BizException.java
        +of(errCode, errMsg) BizException
        +of(errorCode) BizException
    }

    class SysException {
        ğŸ“ user-client/exception/SysException.java
        +wrap(errCode, cause) SysException
    }

    class UserStatus {
        <<enumeration>>
        ğŸ“ user-client/constant/UserStatus.java
        INACTIVE
        ACTIVE
        FROZEN
    }

    %% ==========================================
    %% user-app æ¨¡å—
    %% ==========================================
    class UserApplicationService {
        <<Service>>
        ğŸ“ user-app/UserApplicationService.java
        -userRegisterCmdExe UserRegisterCmdExe
        -userByIdQryExe UserByIdQryExe
        +register(cmd) Response
        +getById(qry) Response
    }

    class UserRegisterCmdExe {
        <<Component>>
        ğŸ“ user-app/executor/UserRegisterCmdExe.java
        @Transactional
        -userRepository IUserRepository
        -emailGateway IEmailGateway
        -smsGateway ISmsGateway
        -userDomainService UserDomainService
        +execute(cmd) Response
        -validate(cmd) void
        -buildUser(cmd) User
        -sendNotifications(cmd, user) void
    }

    class UserRegisterCmdExeWithExtension {
        <<Component>>
        ğŸ“ user-app/executor/UserRegisterCmdExeWithExtension.java
        @Transactional
        -extensionExecutor ExtensionExecutor
        -userRepository IUserRepository
        +execute(cmd, bizScenario) Response
    }

    class UserByIdQryExe {
        <<Component>>
        ğŸ“ user-app/executor/UserByIdQryExe.java
        -userRepository IUserRepository
        -assembler UserAssembler
        +execute(qry) Response
    }

    class UserAssembler {
        <<Component>>
        ğŸ“ user-app/assembler/UserAssembler.java
        +toDTO(user) UserDTO
        +toFullDTO(user) UserDTO
        +toDomain(cmd) User
        +toDTOList(users) List~UserDTO~
        +getMaskedPhone(phone) String
        +getMaskedEmail(email) String
    }

    %% ==========================================
    %% user-domain æ¨¡å— - æ¨¡å‹
    %% ==========================================
    class User {
        <<AggregateRoot>>
        ğŸ“ user-domain/model/User.java
        -Long id
        -String username
        -Email email
        -Phone phone
        -String password
        -UserStatus status
        -LocalDateTime registerTime
        -LocalDateTime lastActiveTime
        +register(encryptedPassword) void
        +activate() void
        +freeze() void
        +changeEmail(newEmail) void
        +updateLastActiveTime() void
        +canActivate() boolean
        +isFrozen() boolean
    }

    class Email {
        <<ValueObject>>
        ğŸ“ user-domain/model/Email.java
        -EMAIL_PATTERN Pattern
        -String value
        +Email(value)
        +isValid(value) boolean
        +getValue() String
    }

    class Phone {
        <<ValueObject>>
        ğŸ“ user-domain/model/Phone.java
        -PHONE_PATTERN Pattern
        -String value
        +Phone(value)
        +isValid(value) boolean
        +getValue() String
    }

    %% ==========================================
    %% user-domain æ¨¡å— - é¢†åŸŸæœåŠ¡
    %% ==========================================
    class UserDomainService {
        <<Service>>
        ğŸ“ user-domain/service/UserDomainService.java
        -userRepository IUserRepository
        +isEmailExists(email) boolean
        +isPhoneExists(phone) boolean
        +isUsernameExists(username) boolean
        +encryptPassword(plainPassword) String
        +verifyPassword(plain, encrypted) boolean
    }

    %% ==========================================
    %% user-domain æ¨¡å— - ä»“å‚¨æ¥å£
    %% ==========================================
    class IUserRepository {
        <<interface>>
        ğŸ“ user-domain/gateway/IUserRepository.java
        +save(user) User
        +findById(id) User
        +findByEmail(email) User
        +findByPhone(phone) User
        +findByUsername(username) User
        +update(user) User
        +delete(id) void
    }

    class IEmailGateway {
        <<interface>>
        ğŸ“ user-domain/gateway/IEmailGateway.java
        +sendWelcomeEmail(to, username) boolean
        +sendVerifyEmail(to, code) boolean
    }

    class ISmsGateway {
        <<interface>>
        ğŸ“ user-domain/gateway/ISmsGateway.java
        +sendRegisterSms(to, username) boolean
        +sendVerifyCode(to, code) boolean
    }

    %% ==========================================
    %% user-domain æ¨¡å— - æ‰©å±•ç‚¹æœºåˆ¶
    %% ==========================================
    class ExtensionPointI {
        <<interface>>
        ğŸ“ user-domain/extension/ExtensionPointI.java
    }

    class Extension {
        <<annotation>>
        ğŸ“ user-domain/extension/Extension.java
        +bizId() String
        +useCase() String
        +scenario() String
        +description() String
    }

    class BizScenario {
        ğŸ“ user-domain/extension/BizScenario.java
        -String bizId
        -String useCase
        -String scenario
        +valueOf(bizId) BizScenario
        +valueOf(bizId, useCase) BizScenario
        +matches(bizId, useCase, scenario) boolean
    }

    class ExtensionExecutor {
        <<Component>>
        ğŸ“ user-domain/extension/ExtensionExecutor.java
        -extensionCache Map
        +execute(extensionPoint, scenario, invoker) R
        +executeVoid(extensionPoint, scenario, invoker) void
        +getExtension(extensionPoint, scenario) T
    }

    class UserValidatorExtPt {
        <<interface>>
        ğŸ“ user-domain/extension/UserValidatorExtPt.java
        +validate(user, scenario) void
    }

    class UserRegisterBonusExtPt {
        <<interface>>
        ğŸ“ user-domain/extension/UserRegisterBonusExtPt.java
        +calculateBonus(userId, scenario) BigDecimal
    }

    class LevelUpgradeExtPt {
        <<interface>>
        ğŸ“ user-domain/extension/LevelUpgradeExtPt.java
        +upgrade(userId, scenario) LevelUpgradeResult
    }

    class RiskCheckExtPt {
        <<interface>>
        ğŸ“ user-domain/extension/RiskCheckExtPt.java
        +check(context) RiskCheckResult
    }

    class PointCalculateExtPt {
        <<interface>>
        ğŸ“ user-domain/extension/PointCalculateExtPt.java
        +calculate(userId, amount) BigDecimal
    }

    class NotificationChannelExtPt {
        <<interface>>
        ğŸ“ user-domain/extension/NotificationChannelExtPt.java
        +getChannels(user) List~String~
    }

    class OrderDiscountExtPt {
        <<interface>>
        ğŸ“ user-domain/extension/OrderDiscountExtPt.java
        +calculateDiscount(order) DiscountResult
    }

    class RegisterValidatorExtPt {
        <<interface>>
        ğŸ“ user-domain/extension/RegisterValidatorExtPt.java
        +validate(cmd) void
    }

    %% æ‰©å±•ç‚¹å®ç°
    class DefaultUserValidatorExt {
        <<@Extension bizId=DEFAULT>>
        ğŸ“ user-domain/extension/impl/DefaultUserValidatorExt.java
        +validate(user, scenario) void
    }

    class VipUserValidatorExt {
        <<@Extension bizId=VIP>>
        ğŸ“ user-domain/extension/impl/VipUserValidatorExt.java
        +validate(user, scenario) void
    }

    class DefaultUserRegisterBonusExt {
        <<@Extension bizId=DEFAULT>>
        ğŸ“ user-domain/extension/impl/DefaultUserRegisterBonusExt.java
        +calculateBonus(userId, scenario) BigDecimal
    }

    class VipUserRegisterBonusExt {
        <<@Extension bizId=VIP>>
        ğŸ“ user-domain/extension/impl/VipUserRegisterBonusExt.java
        +calculateBonus(userId, scenario) BigDecimal
    }

    %% ==========================================
    %% user-infrastructure æ¨¡å—
    %% ==========================================
    class UserRepositoryImpl {
        <<Repository>>
        ğŸ“ user-infrastructure/gatewayimpl/UserRepositoryImpl.java
        -userMapper UserMapper
        -userConverter UserConverter
        +save(user) User
        +findById(id) User
        +findByEmail(email) User
        +findByPhone(phone) User
        +findByUsername(username) User
        +update(user) User
        +delete(id) void
    }

    class EmailGatewayImpl {
        <<Component>>
        ğŸ“ user-infrastructure/gatewayimpl/EmailGatewayImpl.java
        +sendWelcomeEmail(to, username) boolean
        +sendVerifyEmail(to, code) boolean
    }

    class SmsGatewayImpl {
        <<Component>>
        ğŸ“ user-infrastructure/gatewayimpl/SmsGatewayImpl.java
        +sendRegisterSms(to, username) boolean
        +sendVerifyCode(to, code) boolean
    }

    class UserMapper {
        <<MyBatis Mapper>>
        ğŸ“ user-infrastructure/mapper/UserMapper.java
        +insert(po) int
        +selectById(id) UserPO
        +updateById(po) int
        +deleteById(id) int
    }

    class UserPO {
        <<TableName=user>>
        ğŸ“ user-infrastructure/dataobject/UserPO.java
        +Long id
        +String username
        +String email
        +String phone
        +String password
        +String status
        +LocalDateTime registerTime
        +LocalDateTime lastActiveTime
    }

    class UserConverter {
        <<Component>>
        ğŸ“ user-infrastructure/converter/UserConverter.java
        +toDataObject(user) UserPO
        +toDomain(po) User
    }

    %% ==========================================
    %% æ¨¡å—åˆ†ç»„
    %% ==========================================
    class UserStartModule {
        <<module>> ğŸš€ user-start
    }

    class UserAdapterModule {
        <<module>> ğŸ“± user-adapter
    }

    class UserClientModule {
        <<module>> ğŸ“‹ user-client
    }

    class UserAppModule {
        <<module>> âš™ï¸ user-app
    }

    class UserDomainModule {
        <<module>> ğŸ’ user-domain
    }

    class UserInfraModule {
        <<module>> ğŸ”§ user-infrastructure
    }

    %% ==========================================
    %% å…³ç³»å®šä¹‰
    %% ==========================================

    %% user-start
    UserStartModule ..> UserAdapterModule : ä¾èµ–
    UserStartModule ..> UserAppModule : æ‰«æ
    UserStartModule ..> UserInfraModule : æ‰«æ

    %% user-adapter
    UserAdapterModule --> UserClientModule : ä¾èµ–
    UserAdapterModule --> UserAppModule : ä¾èµ–
    UserController --> UserServiceI : uses
    UserController --> UserRegisterCmd : @Valid
    UserController --> Response : returns
    GlobalExceptionHandler --> BizException : catches
    GlobalExceptionHandler --> SysException : catches

    %% user-client
    UserServiceI ..> UserRegisterCmd
    UserServiceI ..> UserByIdQry
    UserServiceI ..> UserDTO
    BizException --> ErrorCode : uses

    %% user-app
    UserAppModule --> UserClientModule : ä¾èµ–
    UserAppModule --> UserDomainModule : ä¾èµ–
    UserApplicationService --> UserRegisterCmdExe : delegates
    UserApplicationService --> UserByIdQryExe : delegates
    UserRegisterCmdExe ..> IUserRepository : uses
    UserRegisterCmdExe ..> IEmailGateway : uses
    UserRegisterCmdExe ..> ISmsGateway : uses
    UserRegisterCmdExe ..> User : uses
    UserRegisterCmdExe ..> UserDomainService : uses
    UserRegisterCmdExeWithExtension ..> ExtensionExecutor : uses
    UserRegisterCmdExeWithExtension ..> IUserRepository : uses
    UserByIdQryExe ..> IUserRepository : uses
    UserByIdQryExe --> UserAssembler : uses

    %% user-domain
    UserDomainModule --> UserClientModule : ä¾èµ–
    User *-- Email : contains
    User *-- Phone : contains
    User *-- UserStatus : contains
    UserDomainService ..> IUserRepository : uses

    %% æ‰©å±•ç‚¹å…³ç³»
    UserValidatorExtPt --|> ExtensionPointI
    UserRegisterBonusExtPt --|> ExtensionPointI
    LevelUpgradeExtPt --|> ExtensionPointI
    RiskCheckExtPt --|> ExtensionPointI
    PointCalculateExtPt --|> ExtensionPointI
    NotificationChannelExtPt --|> ExtensionPointI
    OrderDiscountExtPt --|> ExtensionPointI
    RegisterValidatorExtPt --|> ExtensionPointI

    DefaultUserValidatorExt ..|> UserValidatorExtPt
    VipUserValidatorExt ..|> UserValidatorExtPt
    DefaultUserRegisterBonusExt ..|> UserRegisterBonusExtPt
    VipUserRegisterBonusExt ..|> UserRegisterBonusExtPt

    DefaultUserValidatorExt ..> Extension
    VipUserValidatorExt ..> Extension
    ExtensionExecutor --> BizScenario : uses

    %% user-infrastructure
    UserInfraModule --> UserClientModule : ä¾èµ–
    UserInfraModule --> UserDomainModule : ä¾èµ–
    UserRepositoryImpl ..|> IUserRepository : implements
    EmailGatewayImpl ..|> IEmailGateway : implements
    SmsGatewayImpl ..|> ISmsGateway : implements
    UserRepositoryImpl --> UserMapper : uses
    UserRepositoryImpl --> UserConverter : uses
    UserMapper --> UserPO : operates on
    UserConverter --> UserPO : converts
