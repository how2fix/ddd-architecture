sequenceDiagram
    %% ==========================================
    %% ç”¨æˆ·æ³¨å†Œæ—¶åºå›¾ v2.0 - åŸºäºå®é™…ä»£ç å®ç°
    %% ==========================================

    autonumber
    participant Client as å®¢æˆ·ç«¯<br/>â”â”â”â”â”â”â”<br/>Postman/Browser
    participant Controller as UserController<br/>â”â”â”â”â”â”â”<br/>ğŸ“ user-adapter/web/<br/>UserController.java
    participant AppService as UserApplicationService<br/>â”â”â”â”â”â”â”<br/>ğŸ“ user-app/<br/>UserApplicationService.java
    participant CmdExe as UserRegisterCmdExe<br/>â”â”â”â”â”â”â”<br/>ğŸ“ user-app/executor/<br/>UserRegisterCmdExe.java
    participant User as Userèšåˆæ ¹<br/>â”â”â”â”â”â”â”<br/>ğŸ“ user-domain/model/<br/>User.java
    participant DomainService as UserDomainService<br/>â”â”â”â”â”â”â”<br/>ğŸ“ user-domain/service/<br/>UserDomainService.java
    participant Repo as UserRepositoryImpl<br/>â”â”â”â”â”â”â”<br/>ğŸ“ user-infrastructure/<br/>gatewayimpl/<br/>UserRepositoryImpl.java
    participant Converter as UserConverter<br/>â”â”â”â”â”â”â”<br/>ğŸ“ user-infrastructure/<br/>converter/<br/>UserConverter.java
    participant Mapper as UserMapper<br/>â”â”â”â”â”â”â”<br/>ğŸ“ user-infrastructure/<br/>mapper/<br/>UserMapper.java
    participant DB as æ•°æ®åº“(H2)<br/>â”â”â”â”â”â”â”<br/>userè¡¨
    participant EmailGW as EmailGatewayImpl<br/>â”â”â”â”â”â”â”<br/>ğŸ“ user-infrastructure/<br/>gatewayimpl/<br/>EmailGatewayImpl.java
    participant SmsGW as SmsGatewayImpl<br/>â”â”â”â”â”â”â”<br/>ğŸ“ user-infrastructure/<br/>gatewayimpl/<br/>SmsGatewayImpl.java

    rect rgb(225, 245, 255)
        Note over Client,SmsGW: ğŸ”µ æ­£å¸¸æ³¨å†Œæµç¨‹

        Client->>Controller: POST /api/users/register<br/>{"username": "test", "email": "test@example.com"}
        Note over Controller: @Valid å‚æ•°æ ¡éªŒ<br/>UserRegisterCmd

        Controller->>AppService: register(UserRegisterCmd)
        AppService->>CmdExe: execute(cmd)

        activate CmdExe
        Note over CmdExe: @Transactional äº‹åŠ¡å¼€å§‹

        CmdExe->>CmdExe: 1. validate(cmd)
        Note over CmdExe: é‚®ç®±æ ¼å¼æ ¡éªŒ<br/>æ‰‹æœºå·æ ¼å¼æ ¡éªŒ

        CmdExe->>DomainService: isEmailExists(email)
        DomainService->>Repo: findByEmail(email)
        Repo->>Mapper: selectByEmail(email)
        Mapper->>DB: SELECT * FROM user WHERE email = ?
        DB-->>Mapper: null
        Mapper-->>Repo: null
        Repo-->>DomainService: null (é‚®ç®±ä¸å­˜åœ¨)
        DomainService-->>CmdExe: false

        CmdExe->>DomainService: isPhoneExists(phone)
        DomainService->>Repo: findByPhone(phone)
        Repo->>Mapper: selectByPhone(phone)
        Mapper->>DB: SELECT * FROM user WHERE phone = ?
        DB-->>Mapper: null
        Mapper-->>Repo: null
        Repo-->>DomainService: null
        DomainService-->>CmdExe: false

        CmdExe->>CmdExe: 2. buildUser(cmd)
        Note over CmdExe: åˆ›å»ºEmailå€¼å¯¹è±¡<br/>åˆ›å»ºPhoneå€¼å¯¹è±¡<br/>è‡ªåŠ¨æ ¡éªŒæ ¼å¼

        CmdExe->>DomainService: encryptPassword(password)
        Note over DomainService: BCryptåŠ å¯†ç®—æ³•
        DomainService-->>CmdExe: BCryptåŠ å¯†åçš„å¯†ç 

        CmdExe->>User: new User(id, username, email, phone)
        activate User
        User->>User: Emailå€¼å¯¹è±¡æ„é€ (è‡ªæ ¡éªŒ)
        User->>User: Phoneå€¼å¯¹è±¡æ„é€ (è‡ªæ ¡éªŒ)

        CmdExe->>User: register(encryptedPassword)
        Note over User: è®¾ç½®status=INACTIVE<br/>è®¾ç½®password=åŠ å¯†å<br/>è®¾ç½®registerTime=now()
        User-->>CmdExe: void
        deactivate User

        CmdExe->>Repo: save(user)
        Repo->>Converter: toDataObject(user)
        Note over Converter: Domain â†’ UserPO<br/>å¤„ç†Email/Phoneå€¼å¯¹è±¡
        Converter-->>Repo: UserPO

        Repo->>Mapper: insert(UserPO)
        Mapper->>DB: INSERT INTO user<br/>(username, email, phone, password, status)<br/>VALUES (?, ?, ?, ?, ?)
        DB-->>Mapper: è‡ªå¢ID
        Mapper-->>Repo: UserPO(with ID)
        Repo-->>CmdExe: User (with ID)

        CmdExe->>CmdExe: 5. sendNotifications(cmd, user)

        alt cmd.sendEmail == true
            CmdExe->>EmailGW: sendWelcomeEmail(email, username)
            Note over EmailGW: é˜²è…å±‚<br/>è®°å½•æ—¥å¿—<br/>æ¨¡æ‹Ÿå‘é€
            EmailGW-->>CmdExe: true
        end

        alt cmd.sendSms == true
            CmdExe->>SmsGW: sendRegisterSms(phone, username)
            Note over SmsGW: é˜²è…å±‚<br/>è®°å½•æ—¥å¿—<br/>æ¨¡æ‹Ÿå‘é€
            SmsGW-->>CmdExe: true
        end

        Note over CmdExe: @Transactional äº‹åŠ¡æäº¤

        CmdExe-->>AppService: Response(success=true, data=userId)
        deactivate CmdExe

        AppService-->>Controller: Response
        Controller-->>Client: {"success": true, "data": "1"}
    end

    %% ==========================================
    %% æ‰©å±•ç‚¹æ‰§è¡Œæµç¨‹
    %% ==========================================

    rect rgb(241, 248, 255)
        Note over Client,SmsGW: ğŸŸ£ æ‰©å±•ç‚¹æ‰§è¡Œæµç¨‹ (UserRegisterCmdExeWithExtension)

        participant ExtExec as ExtensionExecutor<br/>â”â”â”â”â”â”â”<br/>ğŸ“ user-domain/extension/<br/>ExtensionExecutor.java
        participant VipValidator as VipUserValidatorExt<br/>â”â”â”â”â”â”â”<br/>ğŸ“ impl/VipUserValidatorExt.java
        participant VipBonus as VipUserRegisterBonusExt<br/>â”â”â”â”â”â”â”<br/>ğŸ“ impl/VipUserRegisterBonusExt.java

        Client->>Controller: POST /api/users/register (VIPç”¨æˆ·)
        Controller->>AppService: register(cmd, VIP)
        AppService->>CmdExe: execute(cmd, BizScenario.VIP.register)

        CmdExe->>ExtExec: executeVoid(UserValidatorExtPt, VIP)
        Note over ExtExec: æŸ¥æ‰¾@Extension(bizId=VIP)
        ExtExec->>VipValidator: validate(user, VIP)
        Note over VipValidator: VIPç”¨æˆ·æ ¡éªŒè§„åˆ™<br/>â”â”â”â”â”â”â”<br/>â€¢ ç”¨æˆ·åâ‰¥5å­—ç¬¦<br/>â€¢ å¿…é¡»æœ‰æ‰‹æœºå·<br/>â€¢ å¿…é¡»æ˜¯ä¼ä¸šé‚®ç®±<br/>(*.company.com)
        VipValidator-->>ExtExec: æ ¡éªŒé€šè¿‡
        ExtExec-->>CmdExe: void

        CmdExe->>User: register(encryptedPassword)
        User-->>CmdExe: void

        CmdExe->>Repo: save(user)
        Repo-->>CmdExe: User(with ID)

        CmdExe->>ExtExec: execute(UserRegisterBonusExtPt, VIP)
        Note over ExtExec: æŸ¥æ‰¾@Extension(bizId=VIP)
        ExtExec->>VipBonus: calculateBonus(userId, VIP)
        Note over VipBonus: VIPç”¨æˆ·æ³¨å†Œå¥–é‡‘<br/>è¿”å› 100.00
        VipBonus-->>ExtExec: BigDecimal(100.00)
        ExtExec-->>CmdExe: 100.00

        CmdExe-->>AppService: Response
        AppService-->>Controller: Response
        Controller-->>Client: {"success": true, "data": "1"}
    end

    %% ==========================================
    %% å¼‚å¸¸å¤„ç†æµç¨‹
    %% ==========================================

    rect rgb(255, 240, 240)
        Note over Client,SmsGW: ğŸ”´ å¼‚å¸¸å¤„ç†æµç¨‹

        participant GlobalExcep as GlobalExceptionHandler<br/>â”â”â”â”â”â”â”<br/>ğŸ“ user-adapter/exception/<br/>GlobalExceptionHandler.java

        Client->>Controller: POST /api/users/register (é‚®ç®±å·²å­˜åœ¨)
        Controller->>AppService: register(cmd)
        AppService->>CmdExe: execute(cmd)

        CmdExe->>DomainService: isEmailExists(email)
        DomainService->>Repo: findByEmail(email)
        Repo->>DB: SELECT * FROM user WHERE email = ?
        DB-->>Repo: UserPO(å·²å­˜åœ¨)
        Repo-->>DomainService: User
        DomainService-->>CmdExe: true

        CmdExe->>CmdExe: throw BizException(EMAIL_ALREADY_EXISTS)

        CmdExe-->>AppService: BizException
        AppService-->>Controller: BizException

        Controller->>GlobalExcep: handleBizException(e)
        Note over GlobalExcep: æ•è·ä¸šåŠ¡å¼‚å¸¸<br/>è¿”å›é”™è¯¯ç å’Œé”™è¯¯ä¿¡æ¯
        GlobalExcep-->>Controller: Response(success=false, errCode="EMAIL_EXISTS")
        Controller-->>Client: {"success": false, "errCode": "EMAIL_EXISTS", "errMessage": "é‚®ç®±å·²å­˜åœ¨"}
    end

    %% ==========================================
    %% ä¾èµ–å€’ç½®ç¤ºæ„
    %% ==========================================

    rect rgb(232, 245, 233)
        Note over Client,SmsGW: ğŸŸ¢ ä¾èµ–å€’ç½®åŸåˆ™ (DIP) ç¤ºæ„

        participant IDomain as Domainå±‚<br/>â”â”â”â”â”â”â”<br/>ğŸ“ user-domain/gateway/<br/>IUserRepository.java (æ¥å£å®šä¹‰)
        participant IInfra as Infrastructureå±‚<br/>â”â”â”â”â”â”â”<br/>ğŸ“ user-infrastructure/<br/>gatewayimpl/<br/>UserRepositoryImpl.java (å®ç°)

        Note over IDomain,IInfra: Domainå±‚å®šä¹‰æ¥å£<br/>Infrastructureå±‚å®ç°æ¥å£<br/>ä¾èµ–æ–¹å‘: Infra â†’ Domain

        CmdExe->>IDomain: save(user) - è°ƒç”¨æ¥å£
        IDomain->>IInfra: æ¥å£è¢«å®ç°
        IInfra->>DB: å®é™…æ•°æ®åº“æ“ä½œ

        Note over IDomain,IInfra: âœ… ä¾èµ–å€’ç½®å®ç°<br/>é«˜å±‚æ¨¡å—(Domain)ä¸ä¾èµ–ä½å±‚æ¨¡å—(Infrastructure)<br/>ä¸¤è€…éƒ½ä¾èµ–æŠ½è±¡(IUserRepositoryæ¥å£)
    end

    %% ==========================================
    %% æ¨¡å—è°ƒç”¨å±‚æ¬¡
    %% ==========================================

    rect rgb(250, 243, 240)
        Note over Client,SmsGW: ğŸŸ  æ¨¡å—è°ƒç”¨å±‚æ¬¡æ€»ç»“

        participant LayerAdapter as Adapterå±‚<br/>â”â”â”â”â”â”â”<br/>user-adapter
        participant LayerApp as Applicationå±‚<br/>â”â”â”â”â”â”â”<br/>user-app
        participant LayerDomain as Domainå±‚<br/>â”â”â”â”â”â”â”<br/>user-domain
        participant LayerInfra as Infrastructureå±‚<br/>â”â”â”â”â”â”â”<br/>user-infrastructure

        Note over LayerAdapter,LayerInfra: è°ƒç”¨é¡ºåº (ä»å¤–åˆ°å†…)

        LayerAdapter->>LayerApp: 1ï¸âƒ£ HTTPè¯·æ±‚ â†’ Application
        LayerApp->>LayerDomain: 2ï¸âƒ£ æµç¨‹ç¼–æ’ â†’ é¢†åŸŸé€»è¾‘
        LayerDomain->>LayerInfra: 3ï¸âƒ£ æ¥å£è°ƒç”¨ â†’ æŠ€æœ¯å®ç°
        LayerInfra->>LayerInfra: 4ï¸âƒ£ æ•°æ®åº“æ“ä½œ

        Note over LayerAdapter,LayerInfra: ä¾èµ–å…³ç³» (åå‘)<br/>user-adapter â†’ user-app â†’ user-domain<br/>user-app â†’ user-infrastructure â†’ user-domain
    end
